# Auth + Sync Fixes (2026-01-14)

This note explains recent changes, why they were not implemented earlier,
and why they are needed now.

## What changed

1) Auth UI stability
- Moved the email/password auth sheet into its own stateful widget with local
  TextEditingControllers and state.
- The SignInPage no longer tries to update or dispose sheet controllers.
- On successful sign-in, the sheet closes first, then the SignInPage route
  closes (if it was opened from the profile sheet).
- Social/guest sign-in flows avoid calling setState after a successful
  sign-in to prevent "widget tree locked" errors during route transitions.

2) Profile sync fallback + diagnostics
- Profile sync now catches permission/network failures and saves locally.
- A non-fatal message is returned for UI display.
- Sync failures are logged to Firestore in clientEvents with a small
  payload (type, code, operation, platform).

3) Firestore rules updates
- Added create-only rules for clientEvents (diagnostics).
- Adjusted user doc update validation to avoid legacy migration fields
  blocking profile updates.
- Allowed server timestamps for updatedAt/createdAt fields to prevent
  permission-denied when using FieldValue.serverTimestamp().
- Relaxed feedback/clientEvents createdAt checks to accept serverTimestamp
  transforms (createdAt present via writeFields even when not in keys()).

4) Calculator save guard
- Saving is now disabled unless at least one event input is entered.
- A user-friendly message appears if a save is attempted without inputs.

5) Duplicate save prevention
- Consecutive saves are blocked when nothing has changed since the last save.
- Users get a clear message when trying to save identical results.

6) Riverpod provider updates + policy date
- Local state providers now use Riverpod 3 NotifierProvider (no legacy
  StateProvider/StateNotifierProvider).
- Privacy policy "Last updated" date reflects 2026-01-14.

7) Account status display
- Settings now shows login status and sign-in method (no email shown).

8) Profile sheet login details
- The profile sheet now shows login type and email (when available).

9) Firestore user update guard
- User doc updates now handle missing documents without rule errors.
- This avoids permission-denied when the app tries update-before-create.

10) Profile sync write strategy
- Profile sync now uses set(merge:true) to create/update user docs in one call.
- This avoids update failures when user documents do not exist.

11) Profile sync payload validation hints
- Added local validation to surface schema/type mismatches when profile sync
  fails with permission-denied.
- Debug logs now include a sanitized payload type summary and field-level hints.

12) App Check removal
- Removed Firebase App Check integration from Flutter and native iOS setup.
- Dropped the debug token UI and Xcode scheme environment variable.
- Removed the iOS App Attest entitlement to avoid device attestation hooks.

13) Profile sync safety guard
- Prevented empty local profile state from overwriting a non-empty cloud profile
  on sign-in (e.g., after sign-out, prefs mismatch, or clock skew).

13) Firestore rules guardrails
- Only validate migration data when it is being written, so legacy fields do not block profile updates.
- Guarded createdAt checks to avoid rules errors when updating a missing score set.

14) Auth test stabilization
- Auth migration tests now use deterministic user streams instead of async controllers.
- Sign-in widget tests scroll against the correct vertical Scrollable to avoid off-screen taps.

15) Profile sync write strategy (legacy cleanup)
- Profile sync now attempts update first to replace the defaultProfile map, removing legacy nested keys.
- Falls back to set on not-found to create missing user docs.

16) Tools tab layout alignment
- Set a fixed height for tool buttons so Body Fat and Lane Planner align evenly.

## Why this was not implemented before

- The original auth flow did not close the email sheet automatically after
  a successful sign-in, so shared controllers were not being disposed while
  the sheet was still animating out.
- There was no requirement to track profile sync failures in Firestore, and
  the rules were not yet tightened around migration fields.
- The new in-app feedback/diagnostics feature introduced a need for
  server-side observability and stricter schema validation.
- The calculator previously relied on total-score presence to enable saving,
  and there was no explicit requirement to block empty saves.
- There was no tracking of the last saved calculator state to prevent
  duplicate saves.
- Riverpod 3 moved StateProvider/StateNotifierProvider into legacy, and the
  app had not yet migrated local state to NotifierProvider.
- The privacy policy date had not been revised since the January 8 draft.
- There was no prior requirement to expose login status details in Settings.
- The profile sheet previously showed actions only, without login detail.
- User doc updates previously used diff(resource.data) without guarding
  for missing documents.
- Profile sync attempted update first, which fails when the user doc does not exist.
- There was no local validation to highlight which fields were failing rule
  checks when permission-denied persisted.
- App Check enforcement was initially kept for backend protection, so a full
  removal was not planned.
- Rules did not previously see update attempts on missing score sets or legacy
  migration fields, so the stricter validation was not a problem.
- The rules required strict timestamp types, which can reject
  server-generated timestamps.
- Auth tests were not run regularly after the sign-in UI became scroll-heavy,
  so the off-screen tap issue went unnoticed.
- Profile sync previously used merge-only writes, which preserved legacy nested
  keys that fail strict rules validation.
- The tools row previously sized to content, so the new Lane Planner label caused
  uneven card heights.

## Why this is needed now

- Creating or signing in was triggering TextEditingController disposal
  errors and "widget tree locked" assertions during route transitions.
- Some existing users saw permission-denied when syncing profile data due to
  stricter rules interacting with legacy fields.
- We need a reliable audit trail for sync failures so issues can be
  investigated without relying on device logs.
- Users can accidentally attempt to save an empty test; blocking this avoids
  confusing, empty saved entries.
- Preventing duplicate saves keeps saved tests clean and reduces accidental
  clutter from repeated taps.
- Using the current Riverpod provider style avoids compile errors and keeps
  local state consistent with the latest API.
- The privacy policy date must reflect when the text was last updated.
- Users need a clear signal for guest vs signed-in status and the sign-in
  method without exposing personal info.
- Users also need the same clarity from the profile menu they use to sign
  in/out.
- The profile sync flow attempts update before set; missing docs were being
  rejected by rules.
- Many users have scoreSets subcollections without a parent user document,
  so set(merge:true) is required to create the parent.
- Profile sync permission-denied errors need actionable hints to isolate
  rule mismatches without exposing user data.
- Profile sync and clientEvents logging must allow server timestamps.
- App Check attestation failures were blocking authenticated reads/writes in
  development, so removing it restores access.
- Rules errors were surfacing for some updates; the guardrails prevent rule
  evaluation failures and reduce false denials.
- Auth tests were flaking due to scroll/stream timing; stabilization ensures
  CI runs are reliable.
- Legacy defaultProfile keys can now be overwritten without relaxing rules.
- The tools row now remains visually even across all tool labels.

## Impact

- Auth flows are more stable (no controller disposal crashes).
- Profile data still saves locally if cloud sync fails.
- Sync failures are now visible in Firestore (clientEvents).
- Empty calculator saves are prevented.
- Consecutive duplicate saves are blocked unless inputs change.
- Local state providers use the current Riverpod 3 API (NotifierProvider).
- Account status and sign-in method are visible in Settings.
- Profile sheet shows login type and email (when available).
- Profile sync no longer fails when the user document does not exist yet.
- Profile sync creates the user document while preserving any existing fields.
- Profile sync failures now include local validation hints for quicker
  rule debugging.
- Rules now accept server timestamps for updatedAt/createdAt fields.
- App Check is fully removed from the client; access now depends solely on
  auth plus Firestore rules (disable App Check enforcement in the console).
- Legacy migration data no longer blocks profile updates.
- Score set updates no longer fail rule evaluation when the doc is missing.
- Auth migration and sign-in navigation tests are now deterministic.
- Profile sync can overwrite legacy defaultProfile keys while keeping migration data.
- Proctor tool tabs now align evenly in the Tools row.
